<?php $bookingStatus = $this->getBookingStatus();
$type = $this->getType();
$locations = $this->getLocations();
$customers = $this->getCustomers();
$services = $this->getServices();
?>
<div class="container-fluid appointmentpro">
    <div class="container-fluid">
        <div id="wrapper" class="left-toggled">
            <div class="right-toggled">
                <div class="sidebars has-sidebar">
                    <?php include(dirname(__DIR__) . "/partials/menu.phtml"); ?>
                    <div class="subcontent third-main-panel">
                        <div class="row app-features">
                            <div class="responsive-part col-md-12">
                                <div class="page-content-wrapper form-horizontal">
                                    <div class="content solo-page">
                                        <h3 class="title-editor border-blue text-center">
                                            <?php echo p__("appointmentpro", "History"); ?>
                                        </h3>
                                        <div class="subcontent content-color container-fluid">
                                            <div class="form-group">

                                                <div id="row">
                                                    <div class="col-md-2">
                                                        <select class="input-flat dt-search color-blue" name="customer_id" id="customer_id" data-dynatable-query="customer_id" data-placeholder="<?php echo p__("appointmentpro", 'Choose Customer'); ?>">
                                                            <option value=""><?php echo p__("appointmentpro", 'Choose Customer'); ?></option>
                                                            <?php foreach ($customers as $key => $value) { ?>
                                                                <option value="<?php echo $value->getId(); ?>"><?php echo $value->getFirstname() . ' (' . $value->getEmail() . ')'; ?></option>
                                                            <?php } ?>
                                                        </select>
                                                    </div>
                                                    <!-- services -->
                                                    <div class="col-md-2">
                                                    <select class="input-flat dt-search color-blue" name="service_id" id="service_id" data-dynatable-query="service_id" data-placeholder="<?php echo p__("appointmentpro", 'Choose Service'); ?>">
                                                            <option value=""><?php echo p__("appointmentpro", 'Choose Service'); ?></option>
                                                            <option value="all"><?php echo p__("appointmentpro", 'All Services'); ?></option>
                                                            <?php foreach ($services as $key => $value) { ?>
                                                                <option value="<?php echo $value->getId(); ?>"><?php echo $value->getName(); ?></option>
                                                            <?php } ?>
                                                        </select>
                                                    </div>
                                                    <!-- reset filter -->
                                                    <div class="col-md-2">
                                                        <!-- <button class="btn color-blue btn-sm" id="resetFilter">
                                                            <i class="fa fa-refresh" aria-hidden="true"></i>
                                                            <?php echo p__("appointmentpro", "Reset"); ?>
                                                        </button> -->
                                                    </div>

                                                    <!-- <?php //if ($type != 'today') : 
                                                            ?>
                                                        <div class="col-md-1">
                                                            <label for="from"><?php //echo  p__("appointmentpro", "From"); 
                                                                                ?></label>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" id="from" name="from" class="input-flat dt-search" autocomplete="off" data-dynatable-query="from">
                                                        </div>
                                                        <div class="col-md-1">
                                                            <label for="to"><?php //echo  p__("appointmentpro", "To"); 
                                                                            ?></label>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" id="to" name="to" class="input-flat dt-search" autocomplete="off" data-dynatable-query="to">
                                                        </div>
                                                    <?php //endif; 
                                                    ?> -->

                                                </div>
                                                <div class="col-md-12">
                                                    <table id="dynamic-location" class="table content-white-bkg sb-pager">
                                                        <thead>
                                                            <tr class="border-grey">
                                                                <th style="width: 10%"><?php echo  p__("appointmentpro", "ID"); ?></th>
                                                                <th style="width: 40%"><?php echo  p__("appointmentpro", "Customer"); ?> / <?php echo  p__("appointmentpro", "Location"); ?> / <?php echo  p__("appointmentpro", "Service"); ?></th>
                                                                <th style="width: 40%"><?php echo  p__("appointmentpro", "Date"); ?></th>
                                                                <!-- <th style="width: 15%"><?php //echo  p__("appointmentpro", "Slot"); 
                                                                                            ?></th> -->
                                                                <!-- <th style="width: 15%"><?php //echo  p__("appointmentpro", "Amount"); 
                                                                                            ?></th> -->
                                                                <!-- <th style="width: 10%"><?php //echo  p__("appointmentpro", "Status"); 
                                                                                            ?></th> -->
                                                                <th style="width: 10%"><?php echo  p__("appointmentpro", "Action"); ?></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="connectedSortable"></tbody>
                                                    </table>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="/app/sae/design/desktop/flat/js/dynatable/jquery.dynatable.css" media="screen" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/app/sae/design/desktop/flat/js/dynatable/jquery.dynatable.js"></script>


<script type="text/javascript">
    var uriParams = {};
    let rowTemplate = `
    <tr class="dynarow booking_row" id="element_(ID)">
        <td>#(ID)</td>
        <td>
            <p><b>(CUSTOMER) ((MOBILE))</b></p>
            <p>(LOCATIONNAME) / (SERVICENAME)</p>
        </td>
        <td>(BOOKINGDATE)</td>
        <td> 
        <ul class="nav nav-pills">
              <li class="dropdown" id="asdf">
                <a class="dropdown-toggle" id="drop4" role="button" data-toggle="dropdown" data-target="#" href="#"><i class="fa fa-ellipsis-v" aria-hidden="true"></i></a>
                <ul id="menu1" class="dropdown-menu" role="menu" aria-labelledby="drop4">
                    <li><a class="edit-location" href="/appointmentpro/booking/view/type/<?php echo $type; ?>/id/(ID)">
                         <i class="fa fa-eye" aria-hidden="true"></i>
                            <?php echo p__("appointmentpro", "View"); ?>
                        </a>
                    </li>
                    <li class="(ISCOMPLETEDHIDE) (ISREJECTEDHIDE) (ISACCEPTEDHIDE)"><a class="booking-status" href="/appointmentpro/booking/update-status/bstatus/3/id/(ID)">
                         <i class="fa fa-check" aria-hidden="true"></i>
                        <?php echo p__("appointmentpro", "Accept"); ?>
                        </a>
                    </li>   
                    <li class="(ISCOMPLETEDHIDE) (ISREJECTEDHIDE) (ISACCEPTEDHIDE)"><a class="booking-status" href="/appointmentpro/booking/update-status/bstatus/8/id/(ID)">
                         <i class="fa fa-times" aria-hidden="true"></i>
                         <?php echo p__("appointmentpro", "Reject"); ?>
                        </a>
                    </li>   
                    <li class="(ISCOMPLETEDHIDE) (ISREJECTEDHIDE) (ISACPJECTACTIONHIDE)"><a class="booking-status" href="/appointmentpro/booking/update-status/bstatus/4/id/(ID)">
                         <i class="fa fa-check-square-o" aria-hidden="true"></i>
                         <?php echo p__("appointmentpro", "Mark As Completed"); ?>
                         
                        </a>
                    </li>   
                    <li class="(ISPAYMENTHIDE) (ISREJECTEDHIDE)"><a class="booking-status" href="/appointmentpro/booking/update-payment-status/pstatus/2/id/(ID)">
                         <i class="fa fa-check-square-o" aria-hidden="true"></i>
                         <?php echo p__("appointmentpro", "Mark As Paid"); ?>
                         
                        </a>
                    </li>                 
                    <li class="divider (ISCOMPLETEDHIDE)"></li>
                    <li class="(ISCOMPLETEDHIDE) (ISREJECTEDHIDE) (ISACPJECTACTIONHIDE)"><a class="booking-status" href="/appointmentpro/booking/update-status/bstatus/6/id/(ID)">
                        <i class="fa fa-times" aria-hidden="true"></i>
                        <?php echo p__("appointmentpro", "Cancel"); ?>
                       </a>
                   </li>
                    <li class="(ISCOMPLETEDHIDE)"><a class="booking-status" href="/appointmentpro/booking/update-status/bstatus/delete/id/(ID)">
                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                        <?php echo p__("appointmentpro", "Delete"); ?>
                       </a>
                   </li>
                </ul>
              </li>
            </ul>
         </td>
       
    </tr>`;

    function rowWriter(rowIndex, record, columns, cellWriter) {
        return rowTemplate
            .replace(/\(ID\)/g, record.appointment_id)
            .replace(/\(CUSTOMER\)/g, record.customer)
            .replace(/\(BOOKINGDATE\)/g, record.booking_date)
            // .replace(/\(STARTTIME\)/g, record.start_time)
            // .replace(/\(ENDTIME\)/g, record.end_time)
            // .replace(/\(AMOUNT\)/g, record.amount_with_currency)
            // .replace(/\(BOOKINGSTATUS\)/g, record.status)
            // .replace(/\(PAYMENTSTATUS\)/g, record.payment_status)
            // .replace(/\(TEXTCOLOR\)/g, record.text_color)
            // .replace(/\(PAYMENTTEXTCOLOR\)/g, record.payment_text_color)
            .replace(/\(SERVICENAME\)/g, record.service_name)
            .replace(/\(LOCATIONNAME\)/g, record.location_name)
            .replace(/\(ISCOMPLETEDHIDE\)/g, record.is_completed_hide)
            .replace(/\(ISREJECTEDHIDE\)/g, record.is_rejected_hide)
            .replace(/\(ISPAYMENTHIDE\)/g, record.is_payment_hide)
            .replace(/\(ISACCEPTEDHIDE\)/g, record.is_accepted_hide)
            .replace(/\(PAYMENTMODE\)/g, record.payment_type)
            .replace(/\(ISACPJECTACTIONHIDE\)/g, record.is_rejected_accepted_action)
            .replace(/\(MOBILE\)/g, record.mobile_number);
    }
    $.dynatableSetup({
        table: {
            defaultColumnIdStyle: 'noStyle'
        },
        features: {
            paginate: true,
            sort: false,
            pushState: true,
            search: false,
            recordCount: false,
            perPageSelect: false,
        },
    });

    let tableCustomers = $('#dynamic-location');
    const $customerSelect = $('#customer_id');
    const $serviceSelect = $('#service_id');

    tableCustomers.bind('dynatable:preinit', function(e, dynatable) {
        dynatable.utility.textTransform.noStyle = function(text) {
            return text;
        };

    });

    tableCustomers.bind('dynatable:afterProcess', function(e, data) {
        console.log("dynatable", data);
        uriParams = data.queries;

        if ($('#customer_id').val() === 'all') {

        } else {
            if (!isNaN(data.queries.customer_id)) {

            } else {

            }
        }

    });

    tableCustomers.bind('dynatable:init', function(e, dynatable) {
        dynatable.queries.functions['to'] = function(r, queryValue) {
            return queryValue;
        };
        dynatable.queries.functions['from'] = function(r, queryValue) {
            return queryValue;
        };

    });

    tableCustomers.bind('dynatable:push', function(e, dynatable) {
        uriParams = dynatable.queries;
    });

    // And on the table
    tableCustomers.dynatable({
        dataset: {
            ajax: true,
            ajaxUrl: '/appointmentpro/history/find-all/type/<?php echo $type; ?>/service_type/services',
            ajaxOnLoad: false,
            records: [],
            perPageDefault: 25
        },
        inputs: {
            processingText: '<?php echo __jss("Loading ...") ?>',
            searchPlaceholder: '<?php echo __jss("Search customer ...") ?>',
            recordCountText: '<?php echo __jss("Showing") ?> ',
            filteredFrom: ' (<?php echo __jss("filtered from #TOTAL# total records") ?>)',
            recordText: '<?php echo __jss("record") ?>',
            recordTextPlural: '<?php echo __jss("records") ?>',
            textOf: '<?php echo __jss("of") ?>',
            textTo: '<?php echo __jss("to") ?>'
        },
        writers: {
            _rowWriter: rowWriter
        }
    });

    $(document).ready(function() {
        const placeholderCustomerOption = $customerSelect.find('option').first().clone();
        const customerOptions = $customerSelect.find('option').not(':first').sort(function(a, b) {
            if (a.text.toLowerCase() > b.text.toLowerCase()) return 1;
            if (a.text.toLowerCase() < b.text.toLowerCase()) return -1;
            return 0;
        });

        $customerSelect.empty().append(placeholderCustomerOption).append(customerOptions);

        if ($.datepicker.regional['<?php echo Core_Model_Language::getCurrentLanguageDatepicker(); ?>']) {
            $.datepicker.setDefaults($.datepicker.regional['<?php echo Core_Model_Language::getCurrentLanguageDatepicker(); ?>']);
        } else {
            $.datepicker.setDefaults($.datepicker.regional['en']);
        }
        $("#from").datepicker({
            changeMonth: true,
            changeYear: true,
            numberOfMonths: 1,
            dateFormat: 'yy-mm-dd',
            onClose: function(selectedDate) {
                $("#to").datepicker("option", "minDate", selectedDate);
            }
        });

        $("#to").datepicker({
            changeMonth: true,
            changeYear: true,
            numberOfMonths: 1,
            dateFormat: 'yy-mm-dd',
            onClose: function(selectedDate) {
                $("#from").datepicker("option", "maxDate", selectedDate);
            }
        });

        var type = "<?php echo $type; ?>";
        if (type == "upcoming") {
            setTimeout(function() {
                $("#from").datepicker("option", "minDate", new Date());
            }, 1500)
        }
    });




    $(document).off("click", ".booking-status");
    $(document).on("click", ".booking-status", function(e) {
        e.preventDefault();
        let deleteHref = $(this).attr("href");
        swal({
            title: "<?php echo P__("appointmentpro", "Confirmation") ?>",
            text: "<?php echo P__("appointmentpro", "Are you sure you want to change status?") ?>",
            showCancelButton: true,
            confirmButtonColor: '#0099C7',
            confirmButtonText: "<?php echo P__("appointmentpro", "Yes!") ?>",
            cancelButtonText: "<?php echo P__("appointmentpro", "No") ?>",
            buttons: true
        }, function(value) {
            if (!value) {
                return false;
            }

            formget(deleteHref, {},
                function(data) {
                    feature_form_success(data.message);
                    // Reload only on success and when done!
                    setTimeout(function() {
                        location.reload();
                    }, 1500)
                },
                function(data) {
                    feature_form_error(JSON.parse(data.responseText).message);
                },
                false);
        });
    });
</script>
<style type="text/css">
    .booking_row>td {
        vertical-align: middle !important;
    }

    .booking_row p {
        margin: 0 0 0px;
    }

    #dynamic-location {
        margin-top: 10px;
        overflow: auto !important;
    }

    .dropdown-menu {
        margin: 0px -140px 0px;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $customerSelect.select2({
            placeholder: $customerSelect.data('placeholder'),
            allowClear: true,
            language: {
                noResults: function() {
                    return "<?php echo P__("appointmentpro", "No results found") ?>";
                }
            }
        });

        $serviceSelect.select2({
            placeholder: $serviceSelect.data('placeholder'),
            allowClear: true,
            language: {
                noResults: function() {
                    return "<?php echo P__("appointmentpro", "No results found") ?>";
                }
            }
        });

        const dynatableInstance = tableCustomers.data('dynatable');

        function removeQuery(dynatable, key) {
            if (!dynatable || !dynatable.queries) {
                return;
            }

            if (typeof dynatable.queries.remove === 'function') {
                dynatable.queries.remove(key);
            } else if (dynatable.queries.queryRecord) {
                delete dynatable.queries.queryRecord[key];
            }
        }

        function clearDynatableData() {
            tableCustomers.find('tbody').empty();

            if (!dynatableInstance) {
                return;
            }

            removeQuery(dynatableInstance, 'customer_id');
            removeQuery(dynatableInstance, 'service_id');

            if (dynatableInstance.settings && dynatableInstance.settings.dataset) {
                dynatableInstance.settings.dataset.records = [];
                dynatableInstance.settings.dataset.originalRecords = [];
            }

            if (dynatableInstance.dom && typeof dynatableInstance.dom.update === 'function') {
                dynatableInstance.dom.update();
            }
        }

        function processDynatableFilters() {
            if (!dynatableInstance) {
                return;
            }

            const customerId = $customerSelect.val();
            const serviceId = $serviceSelect.val();

            removeQuery(dynatableInstance, 'customer_id');
            removeQuery(dynatableInstance, 'service_id');

            if (customerId && serviceId) {
                dynatableInstance.queries.add('customer_id', customerId);
                dynatableInstance.queries.add('service_id', serviceId);
                dynatableInstance.process();
            } else {
                clearDynatableData();
            }
        }

        clearDynatableData();

        $customerSelect.on('change', processDynatableFilters);
        $serviceSelect.on('change', processDynatableFilters);
    });
</script>
